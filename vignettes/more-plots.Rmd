---
title: "Trade sources year coverage p2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Trade sources year coverage p2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(PackageExampleR)
key_path <- here::here(Sys.getenv("GOOGLESHEETS_AUTH_FILE"))
googlesheets4::gs4_auth(path = key_path)
```

First we read the trade sources sheet and build a dataframe where each row accounts for one year.
```{r}
# Step 1: Authentication
sheet_url <- "1UdwgS87x5OsLjNuKaY3JA01GoI5nwsenz62JXCeq0GQ"

# PART 1: trade_sources FOR TRADE

# Step 2: Rest of Program
expanded_trade_sources <-
  sheet_url |>
  googlesheets4::read_sheet(sheet = "Final_Sources_Trade") |>
  expand_trade_sources()
```

Now we build some plots.

Plot showing years covered by `expanded_trade_sources`:
```{r, fig.alt="Plot showing years covered by expanded_trade_sources", fig.width=10,fig.height=5}
ggplot2::ggplot(
  expanded_trade_sources,
  ggplot2::aes(y = Trade, x = Year, fill = "blue")
) +
  ggplot2::geom_tile(alpha = .8) +
  ggplot2::theme_dark() +
  ggplot2::labs(title = "Source Availability by Country") +
  ggplot2::scale_fill_identity() +
  ggplot2::facet_wrap(~Reporter, ncol = 1)
```

Plot showing years covered by `expanded_trade_sources`, colored by scanned/not scanned:
```{r, fig.alt="Plot showing years covered by expanded_trade_sources, colored by scanned/not scanned", fig.width=10,fig.height=5}
ggplot2::ggplot(expanded_trade_sources, ggplot2::aes(y = Trade, x = Year)) +
  ggplot2::geom_tile(ggplot2::aes(fill = factor(Scanned), alpha = .8)) +
  ggplot2::theme_dark() +
  ggplot2::labs(title = "Scanned sources_trade by Country", fill = "Scanned") +
  ggplot2::scale_fill_manual(
    labels = c("0" = "No", "1" = "Yes"), values = c("0" = "red", "1" = "green")
  ) +
  ggplot2::guides(alpha = "none") +
  ggplot2::facet_grid(Reporter ~ ImpExp, scales = "free", space = "free_y")
```

Map showing years of coverage identified by `expanded_trade_sources` for total trade

```{r, fig.alt="Map showing years of coverage identified by `expanded_trade_sources` for total trade", fig.width=10,fig.height=5, fig.align='center'}
#Load Map
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")


#Summarize Trade Dataset, by years covered total trade
sources_trade_sum <- expanded_trade_sources |>
  dplyr::group_by(Reporter_ISO) |>
  dplyr::filter(Trade == "Total") |>
  dplyr::summarize(Years = dplyr::n_distinct(Year))

#join mapdata to trade summary
world_data <- world |>
  dplyr::left_join(sources_trade_sum, by = c("iso_a3_eh" = "Reporter_ISO"))

#Chart Area
xlims <- c(-120, 120)
ylims <- c(-50, 70)
ggplot2::ggplot(world_data) +
  ggplot2::geom_sf(ggplot2::aes(fill = Years), color = "white") +
  #ggplot2::geom_text(ggplot2::aes(label = Years, x = label_x,y = label_y)) +
  ggplot2::scale_fill_gradient(low = "#f5cbcb", high = "#acf2f0", na.value = "grey90", name = "Years") +
  ggplot2::theme_minimal() +
  ggplot2::theme(axis.title.x = ggplot2::element_blank(), axis.title.y = ggplot2::element_blank()) +
  ggplot2::labs(title = "Years of Total Sources by Country") +
  ggplot2::coord_sf(xlim = xlims, ylim = ylims, expand = FALSE)
```

Map showing years of coverage identified by `expanded_trade_sources` for total trade

```{r, fig.alt="Map showing years of coverage identified by `expanded_trade_sources` for total trade", fig.width=7,fig.height=3}
#Load Map
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")


#Summarize Trade Dataset, by years covered bilateral trade
sources_trade_sum <- expanded_trade_sources |>
  dplyr::group_by(Reporter_ISO) |>
  dplyr::filter(Trade == "Bilateral") |>
  dplyr::summarize(Years = dplyr::n_distinct(Year))

#join mapdata to trade summary
world_data <- world |>
  dplyr::left_join(sources_trade_sum, by = c("iso_a3_eh" = "Reporter_ISO"))

#Chart Area
xlims <- c(-180, 180)
ylims <- c(-180, 180)
ggplot2::ggplot(world_data) +
  ggplot2::geom_sf(ggplot2::aes(fill = Years), color = "white") +
  #ggplot2::geom_text(ggplot2::aes(label = Years, x = label_x,y = label_y)) +
  ggplot2::scale_fill_gradient(low = "#f5cbcb", high = "#acf2f0", na.value = "grey90", name = "Years") +
  ggplot2::theme_minimal() +
  ggplot2::theme(axis.title.x = ggplot2::element_blank(), axis.title.y = ggplot2::element_blank()) +
  ggplot2::labs(title = "Years of Bilateral Sources by Country") +
  ggplot2::coord_sf(xlim = xlims, ylim = ylims, expand = FALSE)
```